<!DOCTYPE html>
<!-- DetectX v3.6.0 - Modern UI with Top Navigation -->
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Model</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/app.css?v=3.6.0">
    <link rel="stylesheet" href="css/imgareaselect-default.css">
    <script src="js/jquery-3.7.1.min.js"></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/media-stream-player.min.js"></script>
    <script src="js/jquery.imgareaselect.js"></script>

<style>
    :root {
        --primary-color: #2563eb;
        --primary-dark: #1e40af;
        --primary-light: #3b82f6;
        --success-color: #10b981;
        --danger-color: #ef4444;
        --warning-color: #f59e0b;
        --info-color: #06b6d4;
        --bg-light: #f8fafc;
        --bg-white: #ffffff;
        --text-dark: #1e293b;
        --text-muted: #64748b;
        --border-color: #e2e8f0;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-light);
        color: var(--text-dark);
    }

    /* Top Navigation Bar */
    .top-navbar {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        box-shadow: var(--shadow-lg);
        padding: 0;
        min-height: 64px;
    }

    .navbar-brand {
        font-size: 1.5rem;
        font-weight: 600;
        color: white !important;
        padding: 0.75rem 1.5rem;
    }

    .nav-pills .nav-link {
        color: rgba(255, 255, 255, 0.85);
        border-radius: 8px;
        padding: 0.65rem 1.25rem;
        margin: 0 0.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .nav-pills .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
    }

    .nav-pills .nav-link.active {
        background-color: rgba(255, 255, 255, 0.25);
        color: white;
        font-weight: 600;
    }

    /* Main Content Area */
    .main-content {
        padding: 2rem;
        max-width: 1600px;
        margin: 0 auto;
    }

    /* Cards */
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: var(--shadow-md);
        background: var(--bg-white);
        margin-bottom: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .card-title {
        color: var(--text-dark);
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--bg-light);
    }

    /* Video Display */
    #view {
        border-radius: 0;
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        background: black;
    }

    #viewgroup {
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    #snapshot {
        max-width: 100%;
        max-height: 600px;
        object-fit: contain;
    }

    #video media-stream-player {
        width: 100% !important;
        height: 100% !important;
        object-fit: contain !important;
    }

    /* Ensure imgAreaSelect appears above canvases */
    .imgareaselect-border1,
    .imgareaselect-border2,
    .imgareaselect-border3,
    .imgareaselect-border4,
    .imgareaselect-outer,
    .imgareaselect-selection {
        z-index: 1000 !important;
    }

    .imgareaselect-handle {
        z-index: 1001 !important;
    }

    /* Buttons */
    .btn {
        border-radius: 8px;
        padding: 0.65rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
        border: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-secondary {
        background-color: var(--text-muted);
        color: white;
    }

    .btn-secondary:hover {
        background-color: var(--text-dark);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    /* Form Controls */
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid var(--border-color);
        padding: 0.65rem 1rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-label {
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    /* Table */
    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background-color: var(--bg-light);
        color: var(--text-dark);
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
        padding: 1rem;
    }

    .table tbody td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(248, 250, 252, 0.5);
    }

    /* Info Display */
    .info-item {
        padding: 0.5rem 0;
        color: var(--text-muted);
        font-size: 0.95rem;
    }

    .info-item strong {
        color: var(--text-dark);
    }

    /* Loading Modal removed - Client doesn't load local model */

    /* Responsive */
    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        #snapshot {
            max-height: 400px;
        }

        .navbar-brand {
            font-size: 1.25rem;
        }

        .nav-pills {
            flex-wrap: wrap;
        }
    }
</style>

</head>

<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-expand-lg top-navbar">
        <div class="container-fluid">
            <span class="navbar-brand acapName">Custom Model</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"
                    style="background-color: rgba(255,255,255,0.2); border: none;">
                <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">Detections</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="advanced.html">Configuration</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="cropping.html">Detection Export</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="mqtt.html">MQTT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Loading Modal removed - Client doesn't load local model -->

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Left Column: Video and Settings -->
            <div class="col-lg-8">
                <!-- Video Display Card -->
                <div class="card">
                    <div class="card-body">
                        <div id="view" style="width:1000px; height:562px; max-width:100%; margin:0 auto;">
                            <div style="width:100%; height:100%; position:relative; background-color: black;">
                                <img id="snapshot" src="" style="width:100%; height:100%; position:absolute; top:0px; left:0px; object-fit:contain;">
                                <div id="video" style="width:100%; height:100%; position:absolute; top:0px; left:0px;"></div>
                                <canvas id="overlayCanvas" width="1000" height="1000" style="width:100%; height:100%; position:absolute; top:0px; left:0px; pointer-events:none;"></canvas>
                                <canvas id="canvas" width="1000" height="1000" style="width:100%; height:100%; position:absolute; top:0px; left:0px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detection Settings Card -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Detection Settings</h5>

                        <div class="mb-3 d-flex align-items-center">
                            <label for="settings_confidence" class="form-label fw-bold mb-0" style="min-width: 180px;">Confidence Threshold</label>
                            <select id="settings_confidence" class="setting form-select" style="width: 120px;">
                                <option value="20">20%</option>
                                <option value="30">30%</option>
                                <option value="40">40%</option>
                                <option value="50">50%</option>
                                <option value="60">60%</option>
                                <option value="70">70%</option>
                                <option value="75">75%</option>
                                <option value="80">80%</option>
                                <option value="85">85%</option>
                                <option value="90">90%</option>
                                <option value="95">95%</option>
                            </select>
                        </div>

                        <div class="mb-3 d-flex align-items-center">
                            <label for="settings_scaleMode" class="form-label fw-bold mb-0" style="min-width: 180px;">Scale Mode</label>
                            <select id="settings_scaleMode" class="setting form-select" style="flex: 1;">
                                <option value="balanced">Balanced - Reduced area, good quality</option>
                                <option value="crop">Center-Crop - Smallest area, best quality</option>
                                <option value="letterbox">Letterbox - Full area, less quality</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Video Information</label>
                            <div class="info-item">Capture Resolution: <strong><span id="captureResolution">-</span></strong></div>
                            <div class="info-item">Model Input: <strong><span id="modelResolution">-</span></strong></div>
                            <div class="info-item">Avg Response Time: <strong><span id="avgResponseTime">-</span></strong></div>
                        </div>

                        <div class="d-flex gap-2">
                            <button id="aoi_button" class="btn btn-secondary flex-fill">Set Area Of Interest</button>
                            <button id="size_button" class="btn btn-secondary flex-fill">Set Minimum Size</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Active Events -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Active Event States</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                    </tr>
                                </thead>
                                <tbody id="events-table">
                                    <!-- Data will be appended here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

	<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="errorModalLabel">Error</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					The application is not running.
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>				

    <div class="toast-container position-fixed top-0 end-0 p-3">
    </div>

<script>
var App = 0;
var imageWidth = 800;
var imageHeight = 450;
var videoWidth = 640;
var videoHeight = 360;
var viewWidth = 1000;
var viewHeight = 562;
var inferenceTimer = 0;
var imgAreaSelectInstance = null;
var selectionMode = "";
var setupComplete = false;
		
$(document).ready(function() {
	$.ajax({
		type: "POST",
		url: '/axis-cgi/basicdeviceinfo.cgi',
		dataType: 'json',
		data: '{"apiVersion": "1.0","context": "DetectX","method": "getAllProperties"}',
		cache: false,
		success: function( response ) {
			// if( response.data.propertyList.Soc !== "Axis Artpec-8" ) {
			//	$(".modal-body").html('<b>This camera is not supported.<br/>The camera needs to be based on ARTPEC-8</b>');
			//	$('#errorModal').modal('show');
			//	return;
			// }
			initializePage();
		},
		error: function(response) {
			$('#errorModal').modal('show');
		}
	});
});

function initializePage() {	
	$.ajax({type: "GET",url: 'app',dataType: 'json',cache: false,
		success: function(data) {
			App = data;
			// Update UI elements
			document.title = App.manifest.acapPackageConf.setup.friendlyName;
			$(".acapName").html(App.manifest.acapPackageConf.setup.friendlyName);
			$("#model_status").text("Status: " + App.status.model.status);
			$("#settings_confidence").val(App.settings.confidence);
			$("#settings_scaleMode").val(App.settings.scaleMode || "balanced");

			// Store initial scale mode for revert functionality
			window.previousScaleMode = App.settings.scaleMode || "balanced";

			// Update resolution displays
			if (App.model) {
				$("#captureResolution").text(App.model.videoWidth + " x " + App.model.videoHeight);
				if (App.model.hub) {
					$("#modelResolution").text(App.model.hub.model_width + " x " + App.model.hub.model_height);
				}
			} else {
				// Hub not configured or not reachable - redirect to Configuration page
				window.location.href = "advanced.html";
				return;
			}

			// Always setup 16:9 view
			SetupView();

			// Calculate initial AOI position (direct mapping from 16:9 display space)
			var aoi_x1 = parseInt(App.settings.aoi.x1 * viewWidth / 1000);
			var aoi_x2 = parseInt(App.settings.aoi.x2 * viewWidth / 1000);
			var aoi_y1 = parseInt(App.settings.aoi.y1 * viewHeight / 1000);
			var aoi_y2 = parseInt(App.settings.aoi.y2 * viewHeight / 1000);

			imgAreaSelectInstance = $("#video").imgAreaSelect({
				x1: aoi_x1,
				y1: aoi_y1,
				x2: aoi_x2,
				y2: aoi_y2,
				handles: true, enable:true, movable:true, resizable:true, show:false,
				instance: true,
				onSelectEnd: function(img, selection) {
					// Selection is in display space (viewWidth x viewHeight)
					// Convert to 0-1000 range for 16:9 display (no capture space transformation)
					// Backend will handle transforming detections to display space

					var x1 = Math.round(selection.x1 * 1000 / viewWidth);
					var x2 = Math.round(selection.x2 * 1000 / viewWidth);
					var y1 = Math.round(selection.y1 * 1000 / viewHeight);
					var y2 = Math.round(selection.y2 * 1000 / viewHeight);

					// Ensure proper ordering (handle reverse dragging)
					if (x1 > x2) { var temp = x1; x1 = x2; x2 = temp; }
					if (y1 > y2) { var temp = y1; y1 = y2; y2 = temp; }

					// Clamp to valid range [0, 1000]
					x1 = Math.max(0, Math.min(1000, x1));
					x2 = Math.max(0, Math.min(1000, x2));
					y1 = Math.max(0, Math.min(1000, y1));
					y2 = Math.max(0, Math.min(1000, y2));

					// Ensure non-zero area
					if (x2 - x1 < 10) x2 = Math.min(1000, x1 + 10);
					if (y2 - y1 < 10) y2 = Math.min(1000, y1 + 10);
					if( selectionMode === "aoi" ) {
						// Validate: AOI must be at least as large as size filter
						var sizeW = App.settings.size.x2 - App.settings.size.x1;
						var sizeH = App.settings.size.y2 - App.settings.size.y1;
						var aoiW = x2 - x1;
						var aoiH = y2 - y1;

						if (aoiW < sizeW || aoiH < sizeH) {
							showToast("Area of Interest cannot be smaller than Minimum Size filter (" + sizeW + "x" + sizeH + ")", "danger");
							return;
						}

						App.settings.aoi = { x1, y1, x2, y2 };
						$.ajax({type: "POST",url: "settings",contentType: 'application/json',
							data: JSON.stringify({ aoi: App.settings.aoi }),
							success: function(response) {
								showToast("Area of Interest updated successfully", "success");
							},
							error: function(response) {
								showToast("Failed to update Area of Interest: " + response.statusText, "danger");
							}
						});
					} else {
						// Validate: Size cannot be larger than AOI
						var aoiW = App.settings.aoi.x2 - App.settings.aoi.x1;
						var aoiH = App.settings.aoi.y2 - App.settings.aoi.y1;
						var sizeW = x2 - x1;
						var sizeH = y2 - y1;

						if (sizeW > aoiW || sizeH > aoiH) {
							showToast("Minimum Size cannot be larger than Area of Interest (" + aoiW + "x" + aoiH + ")", "danger");
							return;
						}

						App.settings.size = { x1, y1, x2, y2 };
						$.ajax({type: "POST",url: "settings",contentType: 'application/json',
							data: JSON.stringify({ size: App.settings.size }),
							success: function(response) {
								showToast("Minimum Size updated successfully", "success");
							},
							error: function(response) {
								showToast("Failed to update Minimum Size: " + response.statusText, "danger");
							}
						});
					}
				}
			});
			imgAreaSelectInstance.setOptions({hide:true});
		},
		error: function(response) {
			$(".modal-body").html('<b>The application is not responding<b/>');
			$('#errorModal').modal('show');
		}
	});

	$("#reset_detections").click(function() {
		var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext("2d");
		ctx.beginPath();
		ctx.clearRect(0, 0, 1000, 1000 );
		ctx.stroke();
		appendDataToTable([]);
		$.ajax({type: "GET",url: 'detections?reset=yes',dataType: 'json',cache: false});
	});

	// Set AOI button click handler
	$("#aoi_button").click(function() {
		if (selectionMode === "aoi" ) {
			selectionMode = "none";
			imgAreaSelectInstance.setOptions({hide:true});
			$(this).removeClass('btn-primary').addClass('btn-secondary');
		} else {
			selectionMode = "aoi";

			// Convert AOI from 0-1000 display space to pixel space (direct mapping)
			var x1 = parseInt(App.settings.aoi.x1 * viewWidth / 1000);
			var x2 = parseInt(App.settings.aoi.x2 * viewWidth / 1000);
			var y1 = parseInt(App.settings.aoi.y1 * viewHeight / 1000);
			var y2 = parseInt(App.settings.aoi.y2 * viewHeight / 1000);

			imgAreaSelectInstance.setSelection(x1, y1, x2, y2, 0);
			imgAreaSelectInstance.setOptions({show:true});
			$("#size_button").removeClass('btn-primary').addClass('btn-secondary');
			$(this).removeClass('btn-secondary').addClass('btn-primary');
		}
	});

	$("#size_button").click(function() {
		if (selectionMode === "size" ) {
			selectionMode = "none";
			imgAreaSelectInstance.setOptions({hide:true});
			$(this).removeClass('btn-primary').addClass('btn-secondary');
		} else {
			selectionMode = "size";

			// Convert size from 0-1000 display space to pixel space (direct mapping)
			var x1 = parseInt(App.settings.size.x1 * viewWidth / 1000);
			var x2 = parseInt(App.settings.size.x2 * viewWidth / 1000);
			var y1 = parseInt(App.settings.size.y1 * viewHeight / 1000);
			var y2 = parseInt(App.settings.size.y2 * viewHeight / 1000);

			imgAreaSelectInstance.setSelection(x1, y1, x2, y2, 0);
			imgAreaSelectInstance.setOptions({show:true});
			$(this).removeClass('btn-secondary').addClass('btn-primary');
			$("#aoi_button").removeClass('btn-primary').addClass('btn-secondary');
		}
	});

	$("#settings_confidence").change(function() {
		var confidenceValue = parseInt($(this).val());
		App.settings.confidence = confidenceValue;
		$.ajax({type: "POST",url: "settings",contentType: 'application/json',
			data: JSON.stringify({ confidence: confidenceValue }),
			success: function(response) {
				currentSettings = newSettings;
			},
			error: function(xhr, status, error) {
				alert('Failed to save settings: ' + error);
			}
		});
	});

	$("#settings_scaleMode").change(function() {
		var scaleModeValue = $(this).val();
		App.settings.scaleMode = scaleModeValue;
		window.previousScaleMode = scaleModeValue;

		// Save scale mode - no restart needed
		$.ajax({
			type: "POST",
			url: "settings",
			contentType: 'application/json',
			data: JSON.stringify({ scaleMode: scaleModeValue }),
			success: function(response) {
				// Update scale mode overlay immediately
				drawScaleModeOverlay();
			},
			error: function(xhr, status, error) {
				// Revert selection on error
				$("#settings_scaleMode").val(window.previousScaleMode);
			}
		});
	});

	setInterval( function(){
		$.ajax({type: "GET",url: 'status',dataType: 'json',cache: false,
			success: function( status ) {
				if( !status.model || !status.model.state ) {
					// Hub not ready - skip status update
					return;
				}

				// Hub is ready - continue with status update

				if ($('.modal:visible').length && $('body').hasClass('modal-open')) {
					$('#errorModal').modal('hide');
				};
				
				$("#model_status").text("Status: " + status.model.status);

				// Update average response time
				if (status.model && status.model.averageTime !== undefined) {
					$("#avgResponseTime").text(status.model.averageTime + " ms");
				}

				$('#events-table').empty();
				if( !status.hasOwnProperty("labels") )
					return;

				if( !status.labels.hasOwnProperty("detections") )
					return;
				
				var canvas = document.getElementById('canvas');
				var ctx = canvas.getContext("2d");

				ctx.beginPath();
				ctx.clearRect(0, 0, 1000, 1000 );
				ctx.stroke();
				ctx.lineWidth = 3;
				ctx.strokeStyle = '#FFFF00';
				ctx.font = '24px Arial';  // Set font style and size
				ctx.fillStyle = '#FFFF00'; // Same color as the box
				ctx.beginPath();
				for( var i = 0; i < status.labels.detections.length; i++ ) {
				    var detection = status.labels.detections[i];

					// Transform coordinates from normalized [0,1000] to canvas pixels
					var transformed = transformCoordinates(detection.x, detection.y, detection.w, detection.h);

					ctx.rect(transformed.x, transformed.y, transformed.w, transformed.h);
					var text = detection.label + ': ' + detection.c;
					ctx.fillText(text, transformed.x, transformed.y - 10); // -10 to position
				}
				ctx.stroke();	

				var events = status.events;
				for( var label in events ) {
					if( events[label] ) {
						var row = '<tr><td>' + label + '</td></tr>';
						$('#events-table').append(row);
					}
				};
			},
			error: function() {
				// ACAP is not responding - show loading modal
				$('#modal').show();
			}
		});
	},300);
};			
	  

function transformCoordinates(x, y, w, h) {
	// Coordinates come from backend in 0-1000 range
	// Display is always 16:9, canvas is 1000x1000
	// Client captures 16:9 and Hub returns coordinates already in correct space
	// Just pass through directly - no transformation needed
	return { x: x, y: y, w: w, h: h };
}

function SetupView() {
	// Always display in 16:9 format
	viewWidth = 1000;
	viewHeight = 562;

	// Always use 16:9 video dimensions
	videoWidth = 1280;
	videoHeight = 720;
	imageWidth = 800;
	imageHeight = 450;

	$("#view").css("width", viewWidth + "px");
	$("#view").css("height", viewHeight + "px");

	// Don't create video player - let the VDO stream be used for inference only
	// Hide video div, show snapshot image that refreshes
	$("#video").hide();
	$("#snapshot").show();

	// Refresh snapshot every 500ms to show near-live view
	setInterval(function() {
		var src = "/axis-cgi/jpg/image.cgi?resolution=" + videoWidth + "x" + videoHeight + "&timestamp=" + new Date().getTime();
		$("#snapshot").attr("src", src);
	}, 500);

	// Draw scale mode overlay
	drawScaleModeOverlay();

	setupComplete = true;
}

function drawScaleModeOverlay() {
	var overlayCanvas = document.getElementById('overlayCanvas');
	if (!overlayCanvas) return;

	var ctx = overlayCanvas.getContext("2d");
	ctx.clearRect(0, 0, 1000, 1000);

	// Dark transparent overlay for non-processed areas
	ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';

	var scaleMode = App.settings.scaleMode || "balanced";

	if (scaleMode === "crop") {
		// Center Crop: Only center 1:1 square is processed
		// For 16:9 display (1000x562), center square is 562x562
		var squareSize = viewHeight;  // 562
		var leftBarWidth = (viewWidth - squareSize) / 2;  // 219

		// Draw left and right dark bars
		ctx.fillRect(0, 0, leftBarWidth, 1000);  // Left bar
		ctx.fillRect(viewWidth - leftBarWidth, 0, leftBarWidth, 1000);  // Right bar

	} else if (scaleMode === "balanced") {
		// Balanced: Center 4:3 area is processed (squeezed to 1:1)
		// For 16:9 display (1000x562), center 4:3 area is 749x562
		var processedWidth = viewHeight * 4 / 3;  // 749
		var leftBarWidth = (viewWidth - processedWidth) / 2;  // 125.5

		// Draw left and right dark bars
		ctx.fillRect(0, 0, leftBarWidth, 1000);  // Left bar
		ctx.fillRect(viewWidth - leftBarWidth, 0, leftBarWidth, 1000);  // Right bar

	} else if (scaleMode === "letterbox") {
		// Letterbox: Full 16:9 view is processed (padding added by Hub)
		// No dark overlay needed - entire visible area can have detections
		// Do nothing - clear canvas only
	}
}

function appendDataToTable(dataArray) {
	var $tableBody = $("#detection-table");
	$tableBody.empty(); // Clear existing data
	dataArray.forEach(function(item) {
		var row = '<tr><td>' + item.label + ' </td><td>' + item.c + '</td></tr>';
		$tableBody.append(row);
	});
}

function showToast(message, type = 'danger') {
    const toastContainer = document.querySelector('.toast-container');
    
    // Determine text color class based on type
    const textColorClass = type === 'warning' ? 'text-dark' : 'text-white';
    
    // Create the toast HTML structure
    var toastHtml = '';
    toastHtml += '<div class="toast align-items-center ' + textColorClass + ' bg-' + type + ' border-0" role="alert" aria-live="assertive" aria-atomic="true">';
    toastHtml += '   <div class="d-flex">';
    toastHtml += '     <div class="toast-body">' + message + '</div>';
    toastHtml += '     <button type="button" class="btn-close' + (type === 'warning' ? '' : ' btn-close-white') + ' me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>';
    toastHtml += '   </div>';
    toastHtml += '</div>';
    
    // Rest of the function remains the same
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 4000
    });
    toast.show();
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

</script>
</body>


</html>
